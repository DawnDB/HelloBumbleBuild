import { NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";

// ğŸ” Server-side Supabase (service role)
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

export async function POST(req) {
  try {
    // PayFast sends x-www-form-urlencoded
    const bodyText = await req.text();
    const params = new URLSearchParams(bodyText);

    const paymentStatus = params.get("payment_status");
    const orderNumber = params.get("m_payment_id");
    const pfPaymentId = params.get("pf_payment_id");

    // ğŸ›‘ Basic validation
    if (!orderNumber || !paymentStatus) {
      return NextResponse.json({ error: "Invalid IPN payload" }, { status: 400 });
    }

    // Only process completed payments
    if (paymentStatus !== "COMPLETE") {
      return NextResponse.json({ status: "ignored" }, { status: 200 });
    }

    // ğŸ” Fetch matching order
    const { data: order, error: orderError } = await supabase
      .from("orders")
      .select("id, status")
      .eq("order_number", orderNumber)
      .single();

    if (orderError || !order) {
      return NextResponse.json({ error: "Order not found" }, { status: 404 });
    }

    // ğŸ›‘ Prevent double-processing
    if (order.status === "paid") {
      return NextResponse.json({ status: "already_paid" }, { status: 200 });
    }

    // âœ… Mark order as paid
    const { error: updateError } = await supabase
      .from("orders")
      .update({
        status: "paid",
        paid_at: new Date().toISOString(),
        payfast_payment_id: pfPaymentId,
      })
      .eq("id", order.id);

    if (updateError) throw updateError;

    return NextResponse.json({ status: "success" }, { status: 200 });
  } catch (err) {
    console.error("PayFast IPN error:", err);
    return NextResponse.json(
      { error: "IPN processing failed" },
      { status: 500 }
    );
  }
}
